# Chapter 11: AI Representative Agent
*(builds on [Chapter 10: Identity, Access & Authorization](10_identity__access___authorization_.md))*  

---

## 1. Why do we need an â€œAI Representative Agentâ€?

Picture the **Small Business Administration (SBA)** processing thousands of *Recovery Grant* applications every month.  
Citizens keep writing in:

* â€œThe form is confusing.â€  
* â€œApproval takes too long.â€  
* â€œWhy canâ€™t I track my application?â€

Normally these pain-points sit in an e-mail box until a busy analyst finds time.  
Meanwhile:

* Errors pile up in [HMS-OPS](01_operations___monitoring_hub__hms_ops__.md) logs.  
* Citizens lose trust.

**The AI Representative Agent (AIRA)** is a tireless junior analyst that:

1. Reads live logs & citizen complaints.  
2. Spots repeated friction (â€œform field X causes 18 % of errorsâ€).  
3. Drafts a *policy patch* (e.g., â€œmake field X optionalâ€).  
4. Opens a pull-request in the rulebook ([HMS-CDF](03_policy_engine___hms_cdf__codified_democracy_foundation__.md)).  
5. Waits for humans to reviewâ€”never self-merges (guardrails!).

Result: better services, faster, without burning out real staff.

---

## 2. Key Concepts (Beginner Friendly)

| Term | Think of it asâ€¦ | Why it matters |
|------|-----------------|----------------|
| **Sensor** | The agentâ€™s ears | Stream of data it listens to (logs, complaints). |
| **Insight** | Sticky note | â€œThis field triggers many 400 errors.â€ |
| **Proposal** | Draft memo | Suggested change to policy or process. |
| **Pull-Request (PR)** | Envelope to the rulebook | Formal request in HMS-CDF waiting for review. |
| **Guardrail** | Safety rails | Rules that stop the agent from merging or accessing forbidden data. |

Remember these five words; they frame everything AIRA does.

---

## 3. Quick-Start: Let AIRA fix a confusing form field

Goal: if â‰¥ 15 % of *Business Size* entries are invalid in one day, AIRA will propose to make the field optional.

### 3.1  Define the agent (YAML, 18 lines)

```yaml
# agents/aira_sba.yaml
id: AIRA_SBA_V1
description: "SBA grant form watchdog"
sensors:
  - type: log
    source: hms-ops://grant-form/errors
    filter: code==400 AND field=="business_size"
threshold:
  pct_errors: 15          # %
time_window: 24h
action:
  type: policy_proposal
  target_rulebook: SBA_FORM_RULES
  template: templates/optional_business_size.md
permissions:
  - logs.read
  - cdf.propose
  - notify.slack
```

Explanation  
â€¢ **sensors** tell AIRA where to listen.  
â€¢ **threshold** defines when to act.  
â€¢ **action** points to a markdown template that will become the pull-request body.  
â€¢ **permissions** are checked by the IAA layerâ€”no permission, no action.

### 3.2  The tiny agent runner (Python, 17 lines)

```python
# file: run_agent.py
from hms_agt import AgentRunner      # thin wrapper; see Ch-12
runner = AgentRunner("agents/aira_sba.yaml")
runner.loop_forever()
```

What happens  
1. Runner authenticates as a *service account* (`sub:"service:AIRA_SBA_V1"`).  
2. Subscribes to the error log stream.  
3. Every hour it computes `%errors`.  
4. When â‰¥ 15 %, it fills in the template and calls `cdf.propose()`.

### 3.3  A sample template (13 lines)

```markdown
# Make "Business Size" optional

## Why
`{{pct_errors}} %` of submissions failed yesterday because the
*Business Size* field is unclear for sole proprietors.

## Change
```diff
-  "business_size": { "required": true }
+  "business_size": { "required": false }
```

_This PR was auto-generated by **AIRA_SBA_V1**._
```

> The curly braces are replaced by live data (e.g., `18.2 %`).

---

### 3.4  What youâ€™ll see in the rulebook

```text
Proposal PR-417 opened by service:AIRA_SBA_V1
Title: Make "Business Size" optional
Status: PENDING_REVIEW  ðŸ‘€
```

A Slack notification tags the human **Grant Policy Committee** to review.  
Because of guardrails, *only* humans with the `PolicyCommittee` role can merge.

---

## 4. Step-by-Step Under the Hood

```mermaid
sequenceDiagram
  participant OPS as HMS-OPS Logs
  participant AIRA as AI Rep Agent
  participant CDF as HMS-CDF
  participant OFF as Human Official
  OPS-->>AIRA: stream error logs
  AIRA->>AIRA: compute %errors
  AIRA--)AIRA: crosses 15 %
  AIRA->>CDF: open pull-request
  CDF--)OFF: notify for review
  OFF-->>CDF: approve / reject
```

Plain English:  
1. OPS sends log lines; AIRA computes stats.  
2. Threshold met â†’ PR created.  
3. Humans stay in the loop; AIRA cannot self-merge.

---

## 5. A Peek at the Code

### 5.1  Metric calculation (9 lines)

```python
def pct_error(records):
    bad = sum(1 for r in records if r["code"] == 400)
    total = len(records)
    return 0 if total == 0 else round(100 * bad / total, 1)
```

Simple mathâ€”kept readable for policy analysts who might tweak it.

### 5.2  Guardrail check (12 lines)

```python
def guardrails_ok(pct):
    MAX_CHANGE = 30    # cannot change a rule affecting >30% users
    return pct < MAX_CHANGE
```

If the suggestion would impact too many users, AIRA abstains and pings a human instead.

### 5.3  Submit PR (simplified, 18 lines)

```python
def submit_pr(text):
    from hms_cdf import CDFClient
    cdf = CDFClient(user="service:AIRA_SBA_V1")
    cdf.propose(
        title="Make \"Business Size\" optional",
        text=text,
        tags=["AUTO_GENERATED", "FORM_FRICTION"]
    )
```

Notice the service accountâ€”issued via [Identity, Access & Authorization](10_identity__access___authorization_.md).

---

## 6. Safety & Ethics Guardrails

AIRAâ€™s power is **constrained** by:

1. **Permissions** â€“ defined in its YAML and enforced by IAA.  
2. **Policy Engine** â€“ any PR must still pass [HMS-ESQ](04_compliance___legal_reasoner__hms_esq__.md) legal checks.  
3. **Human Approval** â€“ merging requires a real personâ€™s vote.  
4. **Change Caps** â€“ agent cannot edit rules touching > 30 % of users (configurable).

These four levers ensure helpful automation **without giving the keys to the kingdom**.

---

## 7. Beginner FAQ

**Q: Can AIRA change code too?**  
Only through a PR in the policy repo. Deployment needs human merge + CI. No direct push.

**Q: What models run AIRAâ€™s language features?**  
Default is a small on-prem LLM via [Model Context Protocol (HMS-MCP)](14_model_context_protocol__hms_mcp__.md). Swap-in models are pluggable.

**Q: How do we stop hallucinated proposals?**  
Set `confidence_min: 0.85` in YAML; AIRA only proposes when the modelâ€™s self-score â‰¥ 85 %.

**Q: Can citizens see agent proposals?**  
Yes. Proposals include an *auto-generated* label and appear in the public policy ledger mirror.

---

## 8. Recap & Whatâ€™s Next

You have:

1. Met the **AI Representative Agent**â€”your never-sleeping junior analyst.  
2. Configured it to watch logs, spot friction, and draft a policy PR.  
3. Seen the guardrails that keep humans firmly in control.  
4. Peeked at the minimal code powering metrics, guardrails, and PR submission.

In the next chapter weâ€™ll open the hood further and look at the **generic runtime** that powers *all* agentsâ€”AIRA included.  
Continue to [Chapter 12: Agent Framework Core (HMS-AGT / AGX)](12_agent_framework_core__hms_agt___agx__.md)  

---

---

Generated by [AI Codebase Knowledge Builder](https://github.com/The-Pocket/Tutorial-Codebase-Knowledge)