# Chapter 10: Imprint

Coming from learning about [Configuration (config)](09_configuration__config_.md), let's now explore how we can generate printable documents from our orders. Imagine Alice's pizza order.  After the order is placed, the kitchen needs a printed ticket with all the details: toppings, crust, delivery time, etc.  How do we generate this printable document? That's where the `Imprint` concept comes in.

## What is Imprint?

Imprint is a service that generates printable documents from orders. Think of it like a printing press.  It takes the order information and a template, and produces a printable document like a PDF or a text file.

## Alice's Pizza: The Kitchen Ticket

Let's see how Imprint generates the kitchen ticket for Alice's pizza order.  We'll need a template that defines the layout of the ticket.  This template might look something like this (simplified HTML):

```html
<h1>Pizza Order</h1>
<p>Order Code: {{ order.code }}</p>
<p>Toppings: {{ order.data.toppings }}</p>
<p>Crust: {{ order.data.crust }}</p>
```

This template uses placeholders like `{{ order.code }}` and `{{ order.data.toppings }}` that will be replaced with the actual order data.

## Key Concepts

* **Template:** A file that defines the layout of the printable document.  It can be HTML, plain text, or any other format supported by the Imprint service.
* **Data:** The order information used to fill the placeholders in the template.  This is the `Order` object with its `data` attribute containing the [Custom Fields](07_custom_fields.md).
* **Output:** The generated printable document, typically a PDF or a text file.

## Generating the Kitchen Ticket

To generate the kitchen ticket, we use the `Imprint::Adapter`.

```ruby
# app/controllers/imprint/prints_controller.rb (simplified)
order = Order.find_by_code(params[:order_code])

response = imprint_adapter.print_single_file(order.order_type_print_form_code, 
                                             order.attributes,
                                             convert_to_pdf: params[:convert_to_pdf])

send_data(response.body, type: response.headers[:content_type], # Send the generated file
                         disposition: response.headers[:content_disposition])
```

This code retrieves the order, calls the `print_single_file` method of the `imprint_adapter` with the template code (defined in the [Order Type](03_order_type.md)), the order data, and a flag to convert the output to PDF.  The `send_data` method then sends the generated file to the user.

## Under the Hood

When `print_single_file` is called, the `Imprint::Adapter` communicates with the Imprint service.

```mermaid
sequenceDiagram
    participant PrintsController
    participant Imprint::Adapter
    participant Imprint::API
    participant Imprint Service

    PrintsController->>Imprint::Adapter: print_single_file(template, data)
    Imprint::Adapter->>Imprint::API: post('print', template, data)
    Imprint::API->>Imprint Service: HTTP POST request
    Imprint Service-->>Imprint::API: HTTP response with generated document
    Imprint::API-->>Imprint::Adapter: Response
    Imprint::Adapter-->>PrintsController: Response
```

The `Imprint::Adapter` uses the `Imprint::API` to make an HTTP POST request to the Imprint service. The `Imprint::API` handles authentication and serialization.

```ruby
# app/models/imprint/adapter.rb (simplified)
imprint_api.post('print', template: template_code, data: template_substitution)
```

This code makes a POST request to the `/print` endpoint of the Imprint service, sending the template code and the order data.

The `Imprint::API` is configured using the `Settings::Imprint` class, which loads the configuration from `config/imprint.yml`.

```ruby
# app/models/imprint/api.rb (simplified)
Imprint::API.config = Settings::Imprint[Rails.env]
```

This code loads the Imprint configuration for the current environment.

## Conclusion

You've learned about the `Imprint` concept and how it's used to generate printable documents from orders.  You've seen how to use the `Imprint::Adapter` and how it interacts with the Imprint service.  This concludes our introductory tutorial to the core concepts of HMS-OMS.


---

Generated by [AI Codebase Knowledge Builder](https://github.com/The-Pocket/Tutorial-Codebase-Knowledge)